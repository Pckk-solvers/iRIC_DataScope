# X-Y Value マップ

X-Y Value マップは、入力データ内の格子座標 (X, Y) と任意の変数（Value）を使って、ステップごとの分布を画像として出力する GUI ツールです。ROI（回転矩形）で切り抜いた範囲のみを対象に、プレビュー確認と一括出力が行えます。

---

## 対象と前提

| 項目 | 内容 |
| ---- | ---- |
| 入力 | ランチャーで指定した **プロジェクトフォルダ / `.ipro` / CSV フォルダ（`Result_*.csv`）** |
| Value | DataSource が提供する任意の列（例: ZB, U, V, HS）。GUI のコンボボックスから 1 つ選択 |
| 座標 | CGNS / CSV に含まれるノード座標 (X, Y) を使用 |
| ROI | 中心 (Cx, Cy)、幅、高さ、角度（度単位）で表される回転矩形。編集キャンバスまたは数値入力で指定 |

> **注意**: 境界データは描画対象外です。格子点のみを前提としています。

---

## 画面構成（概要）

1. **左パネル**  
   - 入力/出力パス表示（ランチャーで指定済み）  
   - Value 選択、プレビュー対象ステップ、色設定、スケール設定  
   - ROI 数値入力 (`Cx/Cy/W/H/Angle`)、解像度倍率、出力オプション  
   - 出力ステップ範囲、余白、フォントサイズ、出力ボタン（単ステップ / 指定ステップまとめて）

2. **右上: プレビュー**  
   - Matplotlib ベース。ROI ローカル座標で描画し、出力オプションを忠実に反映  
   - `bbox_inches="tight"` 相当の枠を破線で表示  
   - ROI が未確定または範囲外の場合はステータスメッセージを表示  

3. **右下: 編集キャンバス（全体表示）**  
   - 全体＋10%余白を表示  
   - ROI をドラッグで移動、ハンドルでスケーリング・回転  
   - `Ctrl + マウスホイール` でズーム可能。操作ヒント/現在の設定をオーバーレイ表示  

---

## 基本ワークフロー

1. **Value を選択**  
   初期読み込み後に利用可能な列がコンボボックスへ設定されます。

2. **プレビュー対象ステップを指定**  
   `step` Spinbox でプレビュー用の単一ステップを選択します（出力範囲とは独立）。

3. **ROI を決定**  
   編集キャンバスまたは数値入力で ROI を指定します。`全体表示` ボタンでドメイン全体へリセット可能です。  
   - ROI 未確定時はプレビューに「ROI 確定待ち」が表示されます。  
   - 数値入力は `Enter` またはフォーカスアウトで確定します。

4. **色とスケールを設定**  
   - 色: 「最小/最大の2色」「虹色（iRIC風）」「色相回転」から選択  
   - スケール: `自動（全ステップ）`（ROI 内全ステップの min/max をバックグラウンド計算）または `手動（数値入力）`（vmin/vmax を入力）  
   - `manual` の場合は範囲スライダーでも調整できます。自動計算値を範囲として保持します。

5. **解像度・出力オプションを調整**  
   - 解像度倍率（倍率）は推定格子間隔を基準に dx/dy をスケーリング  
   - 目盛り、枠線、カラーバー、タイトル、カラーバー名、フォントサイズ、`余白(in)`、出力倍率 を指定可能

6. **出力ステップ範囲を設定**  
   - 開始/終了ステップと間引き数 を入力またはレンジスライダーで指定  
   - 範囲外の値は自動で補正されます。

7. **出力を実行**  
   - `現在のステップを出力`: プレビュー中のステップのみ PNG 出力  
   - `指定ステップをまとめて出力`: 指定範囲（開始/終了/skip）で連続出力。進捗バーとログを表示します。

---

## プレビューと出力の挙動

- プレビューは出力処理と同じ `render_xy_value_map` を用いますが、操作中は負荷軽減のため解像度を自動で下げます。
- ROI ドラッグ中は再描画を抑え、リリース時に確定値で描画します。
- カラーマップは `matplotlib` の `pcolormesh(shading="gouraud")` を使用。ROI 外は NaN としてクリップされ、透明表示になります。
- `global` スケールは ROI 確定後にバックグラウンドで再計算され、完了までは暫定値で描画します。
- 出力画像は `step_XXXX.png` の形式で保存され、桁数は総ステップ数に合わせて自動決定します。

---

## 出力オプション詳細

| オプション | 説明 |
| ---------- | ---- |
| タイトル | 任意文字列。空なら非表示 |
| 目盛り | チェックでオン/オフ |
| 枠線 | チェックでオン/オフ |
| カラーバー | チェックでオン/オフ |
| カラーバー名 | 任意文字列。空なら非表示 |
| タイトル / 目盛 / CBラベル フォントサイズ | 個別に指定 |
| 余白(in) | `bbox_inches="tight"` に追加する余白。プレビューと出力で共通 |
| 出力倍率 | プレビューの DPI を倍率変更して出力解像度を調整 |

---

## よくあるエラーと対処

| 症状 | 原因 / 対処 |
| ---- | ---- |
| 「入力データに利用可能な変数が見つかりません」 | 入力ファイルに Value 列が無い。入力を確認 |
| 「ROI 内に点がありません」 | ROI が空領域を指している。ROI を調整 |
| 「ROI 内の Value が全て NaN/Inf」 | データ範囲外。ROI や Value を変更 |
| スケール計算中でプレビューが更新されない | `global` スケール計算が進行中。計算完了を待つか `manual` に切り替え |

---

## 参考情報

- 仕様書: [`docs/specs/xy_value_colormap_export.md`](../specs/xy_value_colormap_export.md)
- GUI から Notion マニュアルを開く: メニュー **ヘルプ → マニュアルを開く** または `Alt + H`

---

以上で、X-Y Value マップ機能の概要と操作手順は完了です。ROI と出力設定を活用して、ステップごとの分布比較にご利用ください。
