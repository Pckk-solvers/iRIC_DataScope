# ステップ別 X-Y 分布画像出力（Value をカラーマップ表示）

## 目的
`.ipro` / `.cgn` を入力として、各ステップの **(X, Y) 平面上の Value 分布**を画像として出力する。

- Value はユーザが変数（列）を選択する
- X, Y は固定（CGNS の座標を使用）
- **矩形領域で切り抜き（ROI）**した範囲のみを出力する
- 全ステップ分の画像を作成し、ステップごとに比較できるようにする

## スコープ
### 対象
- 入力: `.ipro` / `.cgn` / CSVフォルダ（`Result_*.csv`）
- 出力: 画像ファイル（PNG を想定、拡張子は将来追加可能）
- 表示: Matplotlib による散布図（Value を色で表現）+ カラーバー

### 非対象（当面）
- 境界データの可視化
- アニメーション（GIF/MP4）出力（将来検討）

## 入力
### 1) 入力ファイル
- ランチャーで選択された入力パスを対象とする
  - `.ipro` の場合: 内部の CGNS（`Case1.cgn`）を展開して読み込む
  - `.cgn` の場合: CGNS を直接読み込む
  - フォルダの場合: **CSVフォルダ（`Result_*.csv`）**として読み込む（CGNS のフォルダ入力は対象外）
- `.ipro` の場合は内部の `Case1.cgn`（将来オプション化予定）

### 1-1) CSVフォルダ入力の前提
- 1ステップ = `Result_*.csv` 1ファイル
- CSV は iRIC 互換フォーマット（先頭2行: `iRIC output t = ...` と `imax,jmax`）を想定
- ステップ番号はファイル名（`Result_{n}.csv`）から取得し、取得できない場合はソート順で連番とする

### 2) 変数（Value）
- ユーザが選択した 1 変数を Value として使用
- 前提: `cgns_reader.iter_iric_step_frames_from_input()` が生成する DataFrame に列として存在すること
  - 例: `ZB`, `ZS`, `HS`, `U`, `V` など

### 3) 切り抜き領域（ROI）
矩形領域を (X, Y) の座標で指定する。

- 入力形式（案）:
  - 画面上で矩形ドラッグして指定（推奨）
  - あるいは `xmin/xmax/ymin/ymax` の数値入力

### 4) プレビュー対象ステップ
プレビュー表示に使うステップを選択できるようにする。

- 既定: `step=1`（FlowSolutionPointers の 1 始まり）
- UI（案）: `step` を Spinbox/Slider で指定
- 補足: 出力は全ステップ分作成するため、プレビューは「設定確認用」として 1 ステップのみ表示する

## 出力
### 出力先
- ランチャーで指定された出力フォルダ配下
  - 例: `output/<任意>/` のように、機能専用サブフォルダを作成

### 出力ファイル
- ステップごとに 1 枚の画像を出力する
- 例:
  - `step_0001.png`
  - `step_0002.png`
  - ...
- 画像内には以下を含める
  - タイトル（例: `t=...` / `step=...` / `value=<変数名>`）
  - カラーバー（Value のスケール）

## 表示仕様（プロット）
- 描画: `matplotlib.pyplot.scatter(X, Y, c=Value, ...)`
- カラーバー: `plt.colorbar(...)`
- 形状（縦横比）の保持:
  - `ax.set_aspect("equal", adjustable="box")` を基本とし、距離のスケールが歪まないようにする
  - ROI の `xlim/ylim` は固定して、ステップごとにオートスケールで形が変わらないようにする
  - 余白が大きくなる場合は、ROI の縦横比に合わせて `figsize` を決める（例: `width:height ≒ (xmax-xmin):(ymax-ymin)`）
- 色（見た目）:
  - Value の最小色 / 最大色をユーザ指定できる（2色指定 → 線形グラデーション）
  - 例: `LinearSegmentedColormap.from_list(...)`
- スケール（色に割り当てる値の範囲）:
  - `global`（既定）: ROI 内の全ステップを通した min/max で固定（比較目的）
  - `manual`: ユーザが `vmin/vmax` を指定（例: 0〜10 を固定して比較したい場合）

## 期待するユーザフロー（GUI）
1) ランチャーで入力（`.ipro`/`.cgn`）と出力フォルダを選択
2) 本機能を起動
3) Value 変数を選択
4) ROI（矩形）を指定（プレビューでドラッグ or 数値入力）
5) プレビュー対象ステップを選択
6) 色（最小/最大色）とスケール（`global`/`manual`）を指定
   - `manual` の場合は `vmin/vmax` を指定
7) 実行 → 全ステップ分の画像を出力
8) 完了ダイアログで出力先フォルダを案内

## プレビュー仕様（UI/挙動）
プレビューは「ユーザが指定した ROI/変数/色/スケールが意図通りか」を確認するための表示とする。

- プレビューで表示する内容
  - 選択した 1 ステップ分の (X,Y) 散布図 + カラーバー
  - タイトルに `step`, `t`, `value=<列名>` を表示
- 即時反映（必須）
  - Value 変数変更 → 即座に再描画
  - ROI 変更 → 即座に再描画
    - ドラッグ操作の場合は負荷対策として「ドラッグ中は間引き/間隔更新」や「ボタンリリース時に確定更新」も許容
  - 最小/最大色変更 → 即座に再描画
  - スケール変更:
    - `manual`: vmin/vmax 入力を即反映
    - `global`: ROI 内の全ステップを通した min/max を再計算して反映
      - 計算が重い場合は UI を固めないためにバックグラウンド処理 +「計算中」表示を行う（プレビューは計算完了時に更新）
- プレビュー軽量化（推奨）
  - 点数が多い場合は「プレビュー用の最大点数（例: 2万点）」を設け、間引きして描画する
  - 形状を崩さないため、可能なら I/J のストライド間引き（構造格子前提）を優先する
  - 画像出力時はフル解像度で描画する（プレビューと出力を分ける）

## 実装方針（予定）
- データ取得:
  - CGNS入力: `iRIC_DataScope/common/cgns_reader.py` の `iter_iric_step_frames_from_input()` を使用
  - CSVフォルダ入力: `iRIC_DataScope/common/csv_reader.py` の `list_csv_files()` / `read_iric_csv()` を使用
  - どちらの場合も DataFrame を直接処理する（画像化のために CSV 変換は不要）
- ROI 適用:
  - `df[(xmin <= df["X"]) & (df["X"] <= xmax) & (ymin <= df["Y"]) & (df["Y"] <= ymax)]`
- 画像出力:
  - GUI から起動する場合でも、保存処理は `matplotlib` の non-interactive backend（例: `Agg`）で行う
- 進捗/失敗通知:
  - 進捗ウィンドウ + 完了/失敗ダイアログ

## 依存ライブラリ
- 追加候補: `matplotlib`
  - 画像出力に必要
  - PyInstaller への取り込み（collect/hidden-import）の考慮が必要

## エラーと扱い
- Value 列が存在しない
  - エラーダイアログで通知し、実行中止
- ROI 内に点が存在しない
  - そのステップの画像はスキップし、ログに残す
- 出力先に書き込めない
  - エラーダイアログで通知

## 受け入れ条件（最低限）
- `.ipro` または `.cgn` を入力にして全ステップ分の画像が出力される
- ROI 指定が反映され、画像が切り抜き範囲のみで生成される
- Value がカラーマップで表現され、カラーバーが表示される
- 最小/最大色がユーザ指定に従って反映される

## 実装前に決めておくこと（推奨）
- プレビュー実装方式
  - 推奨: Matplotlib の `FigureCanvasTkAgg` + `RectangleSelector` を使用（ROI 指定と描画を同一キャンバスで完結）
- プレビューの間引き方式
  - 推奨: プレビュー用の最大点数（例: 20,000点）を設ける
  - 推奨: 構造格子前提で `I/J` のストライド間引き、難しければランダムサンプリング
- `global` スケールの min/max 計算
  - 推奨: ROI が決まった後に「全ステップを1回スキャンして min/max を算出」し、その後に画像出力（2パス、メモリ節約）
  - UI は計算中の表示（プログレス/キャンセル可否）を決める
- 出力先とファイル名
  - 例: `output/<機能名>_<value名>/step_0001.png`
  - 画像比較が目的なので、全ステップで同じレイアウト（figsize/DPI/カラーバー位置）を固定する
- ROI が空の場合の扱い
  - 決定: そのステップの画像はスキップし、ログに残す
